# Orb Service Documentation

## Обзор

Orb Service - это микросервис, входящий в состав кластерной платформы Lunaricorn. Сервис предназначен для обеспечения функциональности орбитальных узлов кластера и взаимодействия с другими компонентами системы.

## Текущий статус реализации

### ✅ Реализовано

#### 1. Базовая инфраструктура
- **Точка входа**: `main.py` - инициализирует сервис, настраивает логирование и запускает FastAPI сервер
- **FastAPI приложение**: `app.py` - подготовлен каркас приложения (импорты настроены, маршруты еще не реализованы)
- **Конфигурация**: Система конфигурации через переменные окружения
- **Логирование**: Система логирования с ротацией файлов

#### 2. Конфигурация (`internal/orb_types.py`)
- Класс `OrbConfig` (dataclass) для типизированной конфигурации
- Загрузка конфигурации из переменных окружения:
  - `CLUSTER_LEADER_URL` - URL лидера кластера
  - `ORB_API_PORT` - порт для API орб-сервиса
  - `SIGNALING_PUSH_PORT` - порт для push-уведомлений от signaling сервиса
  - Параметры базы данных:
    - `db_type` - тип БД (postgresql)
    - `db_host` - хост БД
    - `db_port` - порт БД
    - `db_user` - пользователь БД
    - `db_password` - пароль БД
    - `db_name` - имя БД
    - `db_schema` - схема БД

#### 3. Интеграция с кластером (`node_config.py`)
- Класс `NodeController` для управления регистрацией узла:
  - Регистрация в кластере через Leader API
  - Ожидание доступности Leader с retry логикой
  - Поддержка прерывания регистрации через `abort_event`
  - Параметры узла:
    - `node_key`: "orb_main"
    - `node_type`: "orb"
    - `node_name`: "orb"

#### 4. Система логирования (`logger_config.py`)
- Функция `setup_orb_logging()` для настройки логирования:
  - Автоматическое определение Docker окружения
  - Ротация лог-файлов (100MB, до 10 backup файлов)
  - Детальное форматирование для файлового лога
  - Упрощенное форматирование для консоли
  - Автоматический бэкап существующих лог-файлов с timestamp
  - Пути логов:
    - Docker: `/opt/lunaricorn/orb_data/logs`
    - Native: `./logs`

#### 5. Docker контейнеризация (`Dockerfile`)
- Базовый образ: Python 3.13.5
- Установка компиляторов (gcc, g++) для сборки зависимостей
- Копирование конфигурации и зависимостей
- Установка пакетов из `requirements.txt` и `lunaricorn/requirements.txt`
- Рабочая директория: `/opt/lunaricorn/orb/app`
- Открытые порты: 8080
- Volumes для данных:
  - `/opt/lunaricorn/orb/data` - конфигурация и данные
  - `/opt/lunaricorn/orb/file_storage` - хранилище файлов

#### 6. Скрипты запуска
- `run.sh` - скрипт для запуска контейнера:
  - Удаление существующего контейнера
  - Создание необходимых директорий
  - Запуск с маппингом портов (8001:8080)
  - Маппинг volumes для данных и файлового хранилища

#### 7. Зависимости (`requirements.txt`)
- `psycopg2-binary` - PostgreSQL драйвер
- `flask` - веб-фреймворк (хотя используется FastAPI, возможно legacy)

#### 8. Подготовка окружения
- `.gitignore` - исключение `.native_env` из репозитория
- `.native_env_example` - пример файла конфигурации для native запуска
- Структура директорий `tmp/` для данных и file_storage

### ⚠️ Частично реализовано

#### FastAPI Application (`app.py`)
- Импорты настроены:
  - FastAPI, StaticFiles
  - Интеграция с leader API
  - Интеграция с signaling client
- **Маршруты API еще не реализованы**
- **Обработчики запросов отсутствуют**

### ❌ Не реализовано

1. **API Endpoints** - нет реализованных HTTP маршрутов
2. **База данных** - нет схемы БД и миграций
3. **Бизнес-логика** - функциональность сервиса не определена
4. **Интеграция с Signaling** - клиент импортирован, но не используется
5. **Файловое хранилище** - директория создана, но логика работы отсутствует
6. **Тесты** - отсутствуют
7. **Документация API** - нет OpenAPI спецификации

## Архитектура

### Компоненты

```
orb/
├── main.py                 # Точка входа, регистрация в кластере
├── app.py                  # FastAPI приложение (каркас)
├── node_config.py          # Контроллер регистрации узла
├── logger_config.py        # Настройка логирования
├── internal/
│   ├── __init__.py
│   └── orb_types.py        # Конфигурация и типы
├── Dockerfile              # Образ контейнера
├── run.sh                  # Скрипт запуска
├── requirements.txt        # Зависимости Python
└── tmp/                    # Временные данные
    ├── data/
    └── file_storage/
```

### Процесс запуска

1. **Инициализация** (`main.py`)
   - Настройка логирования
   - Загрузка конфигурации из env
   - Регистрация в кластере через Leader API
   - Запуск FastAPI сервера (uvicorn)

2. **Регистрация в кластере** (`node_config.py`)
   - Проверка доступности Leader API
   - Ожидание Leader с retry (интервал 5 сек)
   - Регистрация узла с параметрами (node_name, node_key, node_type)

3. **Запуск API сервера**
   - Uvicorn на порту 8080
   - Автоперезагрузка в режиме разработки

## Конфигурация

### Переменные окружения

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `CLUSTER_LEADER_URL` | URL сервиса Leader | `http://leader:8000/` |
| `ORB_API_PORT` | Порт API сервиса | `8080` |
| `SIGNALING_PUSH_PORT` | Порт для push от signaling | `5557` |
| `db_type` | Тип БД | `postgresql` |
| `db_host` | Хост БД | `lunaricorn-pg` |
| `db_port` | Порт БД | `5432` |
| `db_user` | Пользователь БД | `lunaricorn` |
| `db_password` | Пароль БД | `*` |
| `db_name` | Имя БД | `lunaricorn` |
| `db_schema` | Схема БД | `lunaricorn` |

### Файл `.native_env`

Для локального запуска (не в Docker) можно использовать файл `.native_env`:

```bash
db_type=postgresql
db_host=
db_port=8003
db_user=lunaricorn
db_password=
```

## Запуск

### Docker (рекомендуется)

```bash
cd services/orb
./run.sh
```

Или через docker-compose:

```bash
cd services
docker-compose up orb
```

### Native

```bash
cd services/orb
cp .native_env_example .native_env
# Отредактировать .native_env
# Установить переменные окружения
python main.py
```

## Интеграция с другими сервисами

### Leader Service
- Регистрация узла при старте
- Использование `lunaricorn.api.leader.ConnectorUtils`
- Ожидание доступности Leader с автоматическим retry

### Signaling Service
- Импортирован `SignalingClient` из `lunaricorn.api.signaling`
- **Еще не используется в коде**

### PostgreSQL Database
- Конфигурация подключения готова
- **Схема БД и миграции не реализованы**

## Логирование

- **Файл логов**: `logs/orb_api.log` (native) или `/opt/lunaricorn/orb_data/logs/orb_api.log` (Docker)
- **Ротация**: автоматическая при достижении 100MB
- **Backup файлов**: до 10 архивных копий
- **Формат**: детальный с timestamp, именем файла, номером строки, функцией

## Следующие шаги

1. Реализовать API endpoints в `app.py`
2. Создать схему базы данных и миграции
3. Реализовать бизнес-логику сервиса
4. Интегрировать Signaling Client
5. Реализовать файловое хранилище
6. Добавить тесты
7. Обновить `requirements.txt` (убрать flask, добавить fastapi, uvicorn)
8. Добавить обработку ошибок и валидацию

## Примечания

- В `main.py` на строке 27 есть опечатка в сообщении об ошибке: "Setup Signaling cluster node" вместо "Setup Orb cluster node"
- В `requirements.txt` указан `flask`, но используется `fastapi` - возможно, требуется обновление
- FastAPI приложение (`app.py`) содержит только импорты, само приложение не инициализировано

